---
layout:     post
title:      ä»æµè§ˆå™¨å¤šè¿›ç¨‹åˆ°JSå•çº¿ç¨‹ï¼ŒJSè¿è¡Œæœºåˆ¶æœ€å…¨é¢çš„ä¸€æ¬¡æ¢³ç†
category: blog
tags: javascriptè¿è¡Œæœºåˆ¶ javascript
favour: javascriptè¿è¡Œæœºåˆ¶
description: ä»æµè§ˆå™¨å¤šè¿›ç¨‹åˆ°JSå•çº¿ç¨‹ï¼Œå†åˆ°æµè§ˆå™¨æ¸²æŸ“æ­¥éª¤ã€äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ï¼Œå¯¹JSè¿è¡Œæœºåˆ¶çš„ä¸€æ¬¡ç³»ç»Ÿæ¢³ç†
---

## å‰è¨€

**è§è§£æœ‰é™ï¼Œå¦‚æœ‰æè¿°ä¸å½“ä¹‹å¤„ï¼Œè¯·å¸®å¿™åŠæ—¶æŒ‡å‡ºï¼Œå¦‚æœ‰é”™è¯¯ï¼Œä¼šåŠæ—¶ä¿®æ­£ã€‚**

**----------è¶…é•¿æ–‡+å¤šå›¾é¢„è­¦ï¼Œéœ€è¦èŠ±è´¹ä¸å°‘æ—¶é—´ã€‚----------**

*å¦‚æœçœ‹å®Œæœ¬æ–‡åï¼Œè¿˜å¯¹è¿›ç¨‹çº¿ç¨‹å‚»å‚»åˆ†ä¸æ¸…ï¼Œä¸æ¸…æ¥šæµè§ˆå™¨å¤šè¿›ç¨‹ã€æµè§ˆå™¨å†…æ ¸å¤šçº¿ç¨‹ã€JSå•çº¿ç¨‹ã€JSè¿è¡Œæœºåˆ¶çš„åŒºåˆ«ã€‚é‚£ä¹ˆè¯·å›å¤æˆ‘ï¼Œä¸€å®šæ˜¯æˆ‘å†™çš„è¿˜ä¸å¤Ÿæ¸…æ™°ï¼Œæˆ‘æ¥æ”¹ã€‚ã€‚ã€‚*

__----------æ­£æ–‡å¼€å§‹----------__

æœ€è¿‘å‘ç°æœ‰ä¸å°‘ä»‹ç»JSå•çº¿ç¨‹è¿è¡Œæœºåˆ¶çš„æ–‡ç« ï¼Œä½†æ˜¯å‘ç°å¾ˆå¤šéƒ½ä»…ä»…æ˜¯ä»‹ç»æŸä¸€éƒ¨åˆ†çš„çŸ¥è¯†ï¼Œè€Œä¸”å„ä¸ªåœ°æ–¹çš„è¯´æ³•è¿˜ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“é€ æˆå›°æƒ‘ã€‚
å› æ­¤å‡†å¤‡æ¢³ç†è¿™å—çŸ¥è¯†ç‚¹ï¼Œç»“åˆå·²æœ‰çš„è®¤çŸ¥ï¼ŒåŸºäºç½‘ä¸Šçš„å¤§é‡å‚è€ƒèµ„æ–™ï¼Œ
ä»æµè§ˆå™¨å¤šè¿›ç¨‹åˆ°JSå•çº¿ç¨‹ï¼Œå°†JSå¼•æ“çš„è¿è¡Œæœºåˆ¶ç³»ç»Ÿçš„æ¢³ç†ä¸€éã€‚

å±•ç°å½¢å¼ï¼šç”±äºæ˜¯å±äºç³»ç»Ÿæ¢³ç†å‹ï¼Œå°±æ²¡æœ‰ç”±æµ…å…¥æ·±äº†ï¼Œè€Œæ˜¯ä»å¤´åˆ°å°¾çš„æ¢³ç†çŸ¥è¯†ä½“ç³»ï¼Œ
é‡ç‚¹æ˜¯å°†å…³é”®èŠ‚ç‚¹çš„çŸ¥è¯†ç‚¹ä¸²è”èµ·æ¥ï¼Œè€Œä¸æ˜¯ä»…ä»…å‰–ææŸä¸€éƒ¨åˆ†çŸ¥è¯†ã€‚

å†…å®¹æ˜¯ï¼šä»æµè§ˆå™¨è¿›ç¨‹ï¼Œå†åˆ°æµè§ˆå™¨å†…æ ¸è¿è¡Œï¼Œå†åˆ°JSå¼•æ“å•çº¿ç¨‹ï¼Œå†åˆ°JSäº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œä»å¤´åˆ°å°¾ç³»ç»Ÿçš„æ¢³ç†ä¸€éï¼Œæ‘†è„±ç¢ç‰‡åŒ–ï¼Œå½¢æˆä¸€ä¸ªçŸ¥è¯†ä½“ç³»

ç›®æ ‡æ˜¯ï¼šçœ‹å®Œè¿™ç¯‡æ–‡ç« åï¼Œå¯¹æµè§ˆå™¨å¤šè¿›ç¨‹ï¼ŒJSå•çº¿ç¨‹ï¼ŒJSäº‹ä»¶å¾ªç¯æœºåˆ¶è¿™äº›éƒ½èƒ½æœ‰ä¸€å®šç†è§£ï¼Œ
æœ‰ä¸€ä¸ªçŸ¥è¯†ä½“ç³»éª¨æ¶ï¼Œè€Œä¸æ˜¯ä¼¼æ‡‚éæ‡‚çš„æ„Ÿè§‰ã€‚

å¦å¤–ï¼Œæœ¬æ–‡é€‚åˆæœ‰ä¸€å®šç»éªŒçš„å‰ç«¯äººå‘˜ï¼Œ**æ–°æ‰‹è¯·è§„é¿**ï¼Œé¿å…å—åˆ°è¿‡å¤šçš„æ¦‚å¿µå†²å‡»ã€‚å¯ä»¥å…ˆå­˜èµ·æ¥ï¼Œæœ‰äº†ä¸€å®šç†è§£åå†çœ‹ï¼Œä¹Ÿå¯ä»¥åˆ†æˆå¤šæ‰¹æ¬¡è§‚çœ‹ï¼Œé¿å…è¿‡åº¦ç–²åŠ³ã€‚

## å¤§çº²

- åŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹

- æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹çš„

    - æµè§ˆå™¨éƒ½åŒ…å«å“ªäº›è¿›ç¨‹ï¼Ÿ
    
    - æµè§ˆå™¨å¤šè¿›ç¨‹çš„ä¼˜åŠ¿
    
    - é‡ç‚¹æ˜¯æµè§ˆå™¨å†…æ ¸ï¼ˆæ¸²æŸ“è¿›ç¨‹ï¼‰
    
    - Browserè¿›ç¨‹å’Œæµè§ˆå™¨å†…æ ¸ï¼ˆRendererè¿›ç¨‹ï¼‰çš„é€šä¿¡è¿‡ç¨‹

- æ¢³ç†æµè§ˆå™¨å†…æ ¸ä¸­çº¿ç¨‹ä¹‹é—´çš„å…³ç³»

    - GUIæ¸²æŸ“çº¿ç¨‹ä¸JSå¼•æ“çº¿ç¨‹äº’æ–¥
    
    - JSé˜»å¡é¡µé¢åŠ è½½
    
    - WebWorkerï¼ŒJSçš„å¤šçº¿ç¨‹ï¼Ÿ
    
    - WebWorkerä¸SharedWorker
    
- ç®€å•æ¢³ç†ä¸‹æµè§ˆå™¨æ¸²æŸ“æµç¨‹

    - loadäº‹ä»¶ä¸DOMContentLoadedäº‹ä»¶çš„å…ˆå
    
    - cssåŠ è½½æ˜¯å¦ä¼šé˜»å¡domæ ‘æ¸²æŸ“ï¼Ÿ
    
    - æ™®é€šå›¾å±‚å’Œå¤åˆå›¾å±‚
    
- ä»Event Loopè°ˆJSçš„è¿è¡Œæœºåˆ¶

    - äº‹ä»¶å¾ªç¯æœºåˆ¶è¿›ä¸€æ­¥è¡¥å……
    
    - å•ç‹¬è¯´è¯´å®šæ—¶å™¨
    
    - setTimeoutè€Œä¸æ˜¯setInterval
    
- äº‹ä»¶å¾ªç¯è¿›é˜¶ï¼šmacrotaskä¸microtask

- å†™åœ¨æœ€åçš„è¯

## åŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹

çº¿ç¨‹å’Œè¿›ç¨‹åŒºåˆ†ä¸æ¸…ï¼Œæ˜¯å¾ˆå¤šæ–°æ‰‹éƒ½ä¼šçŠ¯çš„é”™è¯¯ï¼Œæ²¡æœ‰å…³ç³»ã€‚è¿™å¾ˆæ­£å¸¸ã€‚å…ˆçœ‹çœ‹ä¸‹é¢è¿™ä¸ªå½¢è±¡çš„æ¯”å–»ï¼š

```js
- è¿›ç¨‹æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œå·¥å‚æœ‰å®ƒçš„ç‹¬ç«‹èµ„æº

- å·¥å‚ä¹‹é—´ç›¸äº’ç‹¬ç«‹

- çº¿ç¨‹æ˜¯å·¥å‚ä¸­çš„å·¥äººï¼Œå¤šä¸ªå·¥äººåä½œå®Œæˆä»»åŠ¡

- å·¥å‚å†…æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå·¥äºº

- å·¥äººä¹‹é—´å…±äº«ç©ºé—´
```

å†å®Œå–„å®Œå–„æ¦‚å¿µï¼š

```js
- å·¥å‚çš„èµ„æº -> ç³»ç»Ÿåˆ†é…çš„å†…å­˜ï¼ˆç‹¬ç«‹çš„ä¸€å—å†…å­˜ï¼‰

- å·¥å‚ä¹‹é—´çš„ç›¸äº’ç‹¬ç«‹ -> è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹

- å¤šä¸ªå·¥äººåä½œå®Œæˆä»»åŠ¡ -> å¤šä¸ªçº¿ç¨‹åœ¨è¿›ç¨‹ä¸­åä½œå®Œæˆä»»åŠ¡

- å·¥å‚å†…æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå·¥äºº -> ä¸€ä¸ªè¿›ç¨‹ç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç»„æˆ

- å·¥äººä¹‹é—´å…±äº«ç©ºé—´ -> åŒä¸€è¿›ç¨‹ä¸‹çš„å„ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å†…å­˜ç©ºé—´ï¼ˆåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®é›†ã€å †ç­‰ï¼‰
```

ç„¶åå†å·©å›ºä¸‹ï¼š

å¦‚æœæ˜¯windowsç”µè„‘ä¸­ï¼Œå¯ä»¥æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªåå°è¿›ç¨‹åˆ—è¡¨ã€‚å¯¹ï¼Œé‚£é‡Œå°±æ˜¯æŸ¥çœ‹è¿›ç¨‹çš„åœ°æ–¹ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜èµ„æºä¿¡æ¯ä»¥åŠcpuå æœ‰ç‡ã€‚

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/process_list.png)

æ‰€ä»¥ï¼Œåº”è¯¥æ›´å®¹æ˜“ç†è§£äº†ï¼š**è¿›ç¨‹æ˜¯cpuèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼ˆç³»ç»Ÿä¼šç»™å®ƒåˆ†é…å†…å­˜ï¼‰**

æœ€åï¼Œå†ç”¨è¾ƒä¸ºå®˜æ–¹çš„æœ¯è¯­æè¿°ä¸€éï¼š

- è¿›ç¨‹æ˜¯cpuèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼ˆæ˜¯èƒ½æ‹¥æœ‰èµ„æºå’Œç‹¬ç«‹è¿è¡Œçš„æœ€å°å•ä½ï¼‰

- çº¿ç¨‹æ˜¯cpuè°ƒåº¦çš„æœ€å°å•ä½ï¼ˆçº¿ç¨‹æ˜¯å»ºç«‹åœ¨è¿›ç¨‹çš„åŸºç¡€ä¸Šçš„ä¸€æ¬¡ç¨‹åºè¿è¡Œå•ä½ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼‰

__tips__

- ä¸åŒè¿›ç¨‹ä¹‹é—´ä¹Ÿå¯ä»¥é€šä¿¡ï¼Œä¸è¿‡ä»£ä»·è¾ƒå¤§

- ç°åœ¨ï¼Œä¸€èˆ¬é€šç”¨çš„å«æ³•ï¼š**å•çº¿ç¨‹ä¸å¤šçº¿ç¨‹**ï¼Œéƒ½æ˜¯æŒ‡**åœ¨ä¸€ä¸ªè¿›ç¨‹å†…**çš„å•å’Œå¤šã€‚ï¼ˆæ‰€ä»¥æ ¸å¿ƒè¿˜æ˜¯å¾—å±äºä¸€ä¸ªè¿›ç¨‹æ‰è¡Œï¼‰

## æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹çš„

ç†è§£äº†è¿›ç¨‹ä¸çº¿ç¨‹äº†åŒºåˆ«åï¼Œæ¥ä¸‹æ¥å¯¹æµè§ˆå™¨è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„è®¤è¯†ï¼šï¼ˆå…ˆçœ‹ä¸‹ç®€åŒ–ç†è§£ï¼‰

- æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹çš„

- æµè§ˆå™¨ä¹‹æ‰€ä»¥èƒ½å¤Ÿè¿è¡Œï¼Œæ˜¯å› ä¸ºç³»ç»Ÿç»™å®ƒçš„è¿›ç¨‹åˆ†é…äº†èµ„æºï¼ˆcpuã€å†…å­˜ï¼‰

- ç®€å•ç‚¹ç†è§£ï¼Œæ¯æ‰“å¼€ä¸€ä¸ªTabé¡µï¼Œå°±ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„æµè§ˆå™¨è¿›ç¨‹ã€‚

å…³äºä»¥ä¸Šå‡ ç‚¹çš„éªŒè¯ï¼Œ**è¯·å†ç¬¬ä¸€å¼ å›¾**ï¼š

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/process_list2.png)

å›¾ä¸­æ‰“å¼€äº†`Chrome`æµè§ˆå™¨çš„å¤šä¸ªæ ‡ç­¾é¡µï¼Œç„¶åå¯ä»¥åœ¨`Chromeçš„ä»»åŠ¡ç®¡ç†å™¨`ä¸­çœ‹åˆ°æœ‰å¤šä¸ªè¿›ç¨‹ï¼ˆåˆ†åˆ«æ˜¯æ¯ä¸€ä¸ªTabé¡µé¢æœ‰ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä»¥åŠä¸€ä¸ªä¸»è¿›ç¨‹ï¼‰ã€‚
æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œå°è¯•ä¸‹ï¼Œå¦‚æœå†å¤šæ‰“å¼€ä¸€ä¸ªTabé¡µï¼Œè¿›ç¨‹æ­£å¸¸ä¼š+1ä»¥ä¸Šï¼ˆä¸è¿‡ï¼ŒæŸäº›ç‰ˆæœ¬çš„ieå´æ˜¯å•è¿›ç¨‹çš„ï¼‰

**æ³¨æ„ï¼š**åœ¨è¿™é‡Œæµè§ˆå™¨åº”è¯¥ä¹Ÿæœ‰è‡ªå·±çš„ä¼˜åŒ–æœºåˆ¶ï¼Œæœ‰æ—¶å€™æ‰“å¼€å¤šä¸ªtabé¡µåï¼Œå¯ä»¥åœ¨Chromeä»»åŠ¡ç®¡ç†å™¨ä¸­çœ‹åˆ°ï¼Œæœ‰äº›è¿›ç¨‹è¢«åˆå¹¶äº†
ï¼ˆæ‰€ä»¥æ¯ä¸€ä¸ªTabæ ‡ç­¾å¯¹åº”ä¸€ä¸ªè¿›ç¨‹å¹¶ä¸ä¸€å®šæ˜¯ç»å¯¹çš„ï¼‰

### æµè§ˆå™¨éƒ½åŒ…å«å“ªäº›è¿›ç¨‹ï¼Ÿ

çŸ¥é“äº†æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹åï¼Œå†æ¥çœ‹çœ‹å®ƒåˆ°åº•åŒ…å«å“ªäº›è¿›ç¨‹ï¼šï¼ˆä¸ºäº†ç®€åŒ–ç†è§£ï¼Œä»…åˆ—ä¸¾ä¸»è¦è¿›ç¨‹ï¼‰

1. Browserè¿›ç¨‹ï¼šæµè§ˆå™¨çš„ä¸»è¿›ç¨‹ï¼ˆè´Ÿè´£åè°ƒã€ä¸»æ§ï¼‰ï¼Œåªæœ‰ä¸€ä¸ªã€‚ä½œç”¨æœ‰

    - è´Ÿè´£æµè§ˆå™¨ç•Œé¢æ˜¾ç¤ºï¼Œä¸ç”¨æˆ·äº¤äº’ã€‚å¦‚å‰è¿›ï¼Œåé€€ç­‰
    
    - è´Ÿè´£å„ä¸ªé¡µé¢çš„ç®¡ç†ï¼Œåˆ›å»ºå’Œé”€æ¯å…¶ä»–è¿›ç¨‹
    
    - å°†Rendererè¿›ç¨‹å¾—åˆ°çš„å†…å­˜ä¸­çš„Bitmapï¼Œç»˜åˆ¶åˆ°ç”¨æˆ·ç•Œé¢ä¸Š
    
    - ç½‘ç»œèµ„æºçš„ç®¡ç†ï¼Œä¸‹è½½ç­‰
    
2. ç¬¬ä¸‰æ–¹æ’ä»¶è¿›ç¨‹ï¼šæ¯ç§ç±»å‹çš„æ’ä»¶å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œä»…å½“ä½¿ç”¨è¯¥æ’ä»¶æ—¶æ‰åˆ›å»º

3. GPUè¿›ç¨‹ï¼šæœ€å¤šä¸€ä¸ªï¼Œç”¨äº3Dç»˜åˆ¶ç­‰

4. æµè§ˆå™¨æ¸²æŸ“è¿›ç¨‹ï¼ˆæµè§ˆå™¨å†…æ ¸ï¼‰ï¼ˆRendererè¿›ç¨‹ï¼Œå†…éƒ¨æ˜¯å¤šçº¿ç¨‹çš„ï¼‰ï¼šé»˜è®¤æ¯ä¸ªTabé¡µé¢ä¸€ä¸ªè¿›ç¨‹ï¼Œäº’ä¸å½±å“ã€‚ä¸»è¦ä½œç”¨ä¸º

    - é¡µé¢æ¸²æŸ“ï¼Œè„šæœ¬æ‰§è¡Œï¼Œäº‹ä»¶å¤„ç†ç­‰
    
å¼ºåŒ–è®°å¿†ï¼š**åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªç½‘é¡µç›¸å½“äºæ–°èµ·äº†ä¸€ä¸ªè¿›ç¨‹ï¼ˆè¿›ç¨‹å†…æœ‰è‡ªå·±çš„å¤šçº¿ç¨‹ï¼‰**

å½“ç„¶ï¼Œæµè§ˆå™¨æœ‰æ—¶ä¼šå°†å¤šä¸ªè¿›ç¨‹åˆå¹¶ï¼ˆè­¬å¦‚æ‰“å¼€å¤šä¸ªç©ºç™½æ ‡ç­¾é¡µåï¼Œä¼šå‘ç°å¤šä¸ªç©ºç™½æ ‡ç­¾é¡µè¢«åˆå¹¶æˆäº†ä¸€ä¸ªè¿›ç¨‹ï¼‰ï¼Œå¦‚å›¾

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/process_list3.png)

å¦å¤–ï¼Œå¯ä»¥é€šè¿‡Chromeçš„`æ›´å¤šå·¥å…· -> ä»»åŠ¡ç®¡ç†å™¨`è‡ªè¡ŒéªŒè¯

### æµè§ˆå™¨å¤šè¿›ç¨‹çš„ä¼˜åŠ¿

ç›¸æ¯”äºå•è¿›ç¨‹æµè§ˆå™¨ï¼Œå¤šè¿›ç¨‹æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

- é¿å…å•ä¸ªpage crashå½±å“æ•´ä¸ªæµè§ˆå™¨

- é¿å…ç¬¬ä¸‰æ–¹æ’ä»¶crashå½±å“æ•´ä¸ªæµè§ˆå™¨

- å¤šè¿›ç¨‹å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿

- æ–¹ä¾¿ä½¿ç”¨æ²™ç›’æ¨¡å‹éš”ç¦»æ’ä»¶ç­‰è¿›ç¨‹ï¼Œæé«˜æµè§ˆå™¨ç¨³å®šæ€§

ç®€å•ç‚¹ç†è§£ï¼š**å¦‚æœæµè§ˆå™¨æ˜¯å•è¿›ç¨‹ï¼Œé‚£ä¹ˆæŸä¸ªTabé¡µå´©æºƒäº†ï¼Œå°±å½±å“äº†æ•´ä¸ªæµè§ˆå™¨ï¼Œä½“éªŒæœ‰å¤šå·®ï¼›åŒç†å¦‚æœæ˜¯å•è¿›ç¨‹ï¼Œæ’ä»¶å´©æºƒäº†ä¹Ÿä¼šå½±å“æ•´ä¸ªæµè§ˆå™¨ï¼›è€Œä¸”å¤šè¿›ç¨‹è¿˜æœ‰å…¶å®ƒçš„è¯¸å¤šä¼˜åŠ¿ã€‚ã€‚ã€‚**

å½“ç„¶ï¼Œå†…å­˜ç­‰èµ„æºæ¶ˆè€—ä¹Ÿä¼šæ›´å¤§ï¼Œæœ‰ç‚¹ç©ºé—´æ¢æ—¶é—´çš„æ„æ€ã€‚

### é‡ç‚¹æ˜¯æµè§ˆå™¨å†…æ ¸ï¼ˆæ¸²æŸ“è¿›ç¨‹ï¼‰
    
é‡ç‚¹æ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢æåˆ°äº†è¿™ä¹ˆå¤šçš„è¿›ç¨‹ï¼Œé‚£ä¹ˆï¼Œå¯¹äºæ™®é€šçš„å‰ç«¯æ“ä½œæ¥è¯´ï¼Œæœ€ç»ˆè¦çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯**æ¸²æŸ“è¿›ç¨‹**

å¯ä»¥è¿™æ ·ç†è§£ï¼Œé¡µé¢çš„æ¸²æŸ“ï¼ŒJSçš„æ‰§è¡Œï¼Œäº‹ä»¶çš„å¾ªç¯ï¼Œéƒ½åœ¨è¿™ä¸ªè¿›ç¨‹å†…è¿›è¡Œã€‚æ¥ä¸‹æ¥é‡ç‚¹åˆ†æè¿™ä¸ªè¿›ç¨‹

**è¯·ç‰¢è®°ï¼Œæµè§ˆå™¨çš„æ¸²æŸ“è¿›ç¨‹æ˜¯å¤šçº¿ç¨‹çš„**ï¼ˆè¿™ç‚¹å¦‚æœä¸ç†è§£ï¼Œ**è¯·å›å¤´çœ‹è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ†**ï¼‰

ç»ˆäºåˆ°äº†çº¿ç¨‹è¿™ä¸ªæ¦‚å¿µäº†ğŸ˜­ï¼Œå¥½äº²åˆ‡ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥çœ‹çœ‹å®ƒéƒ½åŒ…å«äº†å“ªäº›çº¿ç¨‹ï¼ˆåˆ—ä¸¾ä¸€äº›ä¸»è¦å¸¸é©»çº¿ç¨‹ï¼‰ï¼š

1. GUIæ¸²æŸ“çº¿ç¨‹

    - è´Ÿè´£æ¸²æŸ“æµè§ˆå™¨ç•Œé¢ï¼Œè§£æHTMLï¼ŒCSSï¼Œæ„å»ºDOMæ ‘å’ŒRenderObjectæ ‘ï¼Œå¸ƒå±€å’Œç»˜åˆ¶ç­‰ã€‚

    - å½“ç•Œé¢éœ€è¦é‡ç»˜ï¼ˆRepaintï¼‰æˆ–ç”±äºæŸç§æ“ä½œå¼•å‘å›æµ(reflow)æ—¶ï¼Œè¯¥çº¿ç¨‹å°±ä¼šæ‰§è¡Œ
    
    - æ³¨æ„ï¼Œ**GUIæ¸²æŸ“çº¿ç¨‹ä¸JSå¼•æ“çº¿ç¨‹æ˜¯äº’æ–¥çš„**ï¼Œå½“JSå¼•æ“æ‰§è¡Œæ—¶GUIçº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ˆç›¸å½“äºè¢«å†»ç»“äº†ï¼‰ï¼ŒGUIæ›´æ–°ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­**ç­‰åˆ°JSå¼•æ“ç©ºé—²æ—¶**ç«‹å³è¢«æ‰§è¡Œã€‚

2. JSå¼•æ“çº¿ç¨‹

    - ä¹Ÿç§°ä¸ºJSå†…æ ¸ï¼Œè´Ÿè´£å¤„ç†Javascriptè„šæœ¬ç¨‹åºã€‚ï¼ˆä¾‹å¦‚V8å¼•æ“ï¼‰
    
    - JSå¼•æ“çº¿ç¨‹è´Ÿè´£è§£æJavascriptè„šæœ¬ï¼Œè¿è¡Œä»£ç ã€‚
    
    - JSå¼•æ“ä¸€ç›´ç­‰å¾…ç€ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„åˆ°æ¥ï¼Œç„¶ååŠ ä»¥å¤„ç†ï¼Œä¸€ä¸ªTabé¡µï¼ˆrendererè¿›ç¨‹ï¼‰ä¸­æ— è®ºä»€ä¹ˆæ—¶å€™éƒ½åªæœ‰ä¸€ä¸ªJSçº¿ç¨‹åœ¨è¿è¡ŒJSç¨‹åº
    
    - åŒæ ·æ³¨æ„ï¼Œ**GUIæ¸²æŸ“çº¿ç¨‹ä¸JSå¼•æ“çº¿ç¨‹æ˜¯äº’æ–¥çš„**ï¼Œæ‰€ä»¥å¦‚æœJSæ‰§è¡Œçš„æ—¶é—´è¿‡é•¿ï¼Œè¿™æ ·å°±ä¼šé€ æˆé¡µé¢çš„æ¸²æŸ“ä¸è¿è´¯ï¼Œå¯¼è‡´é¡µé¢æ¸²æŸ“åŠ è½½é˜»å¡ã€‚

3. äº‹ä»¶è§¦å‘çº¿ç¨‹

    - å½’å±äºæµè§ˆå™¨è€Œä¸æ˜¯JSå¼•æ“ï¼Œç”¨æ¥æ§åˆ¶äº‹ä»¶å¾ªç¯ï¼ˆå¯ä»¥ç†è§£ï¼ŒJSå¼•æ“è‡ªå·±éƒ½å¿™ä¸è¿‡æ¥ï¼Œéœ€è¦æµè§ˆå™¨å¦å¼€çº¿ç¨‹ååŠ©ï¼‰

    - å½“JSå¼•æ“æ‰§è¡Œä»£ç å—å¦‚setTimeOutæ—¶ï¼ˆä¹Ÿå¯æ¥è‡ªæµè§ˆå™¨å†…æ ¸çš„å…¶ä»–çº¿ç¨‹,å¦‚é¼ æ ‡ç‚¹å‡»ã€AJAXå¼‚æ­¥è¯·æ±‚ç­‰ï¼‰ï¼Œä¼šå°†å¯¹åº”ä»»åŠ¡æ·»åŠ åˆ°äº‹ä»¶çº¿ç¨‹ä¸­

    - å½“å¯¹åº”çš„äº‹ä»¶ç¬¦åˆè§¦å‘æ¡ä»¶è¢«è§¦å‘æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼šæŠŠäº‹ä»¶æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œç­‰å¾…JSå¼•æ“çš„å¤„ç†
    
    - æ³¨æ„ï¼Œç”±äºJSçš„å•çº¿ç¨‹å…³ç³»ï¼Œæ‰€ä»¥è¿™äº›å¾…å¤„ç†é˜Ÿåˆ—ä¸­çš„äº‹ä»¶éƒ½å¾—æ’é˜Ÿç­‰å¾…JSå¼•æ“å¤„ç†ï¼ˆå½“JSå¼•æ“ç©ºé—²æ—¶æ‰ä¼šå»æ‰§è¡Œï¼‰
        
4. å®šæ—¶è§¦å‘å™¨çº¿ç¨‹

    - ä¼ è¯´ä¸­çš„`setInterval`ä¸`setTimeout`æ‰€åœ¨çº¿ç¨‹
    
    - æµè§ˆå™¨å®šæ—¶è®¡æ•°å™¨å¹¶ä¸æ˜¯ç”±JavaScriptå¼•æ“è®¡æ•°çš„,ï¼ˆå› ä¸ºJavaScriptå¼•æ“æ˜¯å•çº¿ç¨‹çš„, å¦‚æœå¤„äºé˜»å¡çº¿ç¨‹çŠ¶æ€å°±ä¼šå½±å“è®°è®¡æ—¶çš„å‡†ç¡®ï¼‰
    
    - å› æ­¤é€šè¿‡å•ç‹¬çº¿ç¨‹æ¥è®¡æ—¶å¹¶è§¦å‘å®šæ—¶ï¼ˆè®¡æ—¶å®Œæ¯•åï¼Œæ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…JSå¼•æ“ç©ºé—²åæ‰§è¡Œï¼‰
    
    - æ³¨æ„ï¼ŒW3Cåœ¨HTMLæ ‡å‡†ä¸­è§„å®šï¼Œè§„å®šè¦æ±‚setTimeoutä¸­ä½äº4msçš„æ—¶é—´é—´éš”ç®—ä¸º4msã€‚
    
5. å¼‚æ­¥httpè¯·æ±‚çº¿ç¨‹

    - åœ¨XMLHttpRequeståœ¨è¿æ¥åæ˜¯é€šè¿‡æµè§ˆå™¨æ–°å¼€ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚
    
    - å°†æ£€æµ‹åˆ°çŠ¶æ€å˜æ›´æ—¶ï¼Œå¦‚æœè®¾ç½®æœ‰å›è°ƒå‡½æ•°ï¼Œå¼‚æ­¥çº¿ç¨‹å°±**äº§ç”ŸçŠ¶æ€å˜æ›´äº‹ä»¶**ï¼Œå°†è¿™ä¸ªå›è°ƒå†æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚å†ç”±JavaScriptå¼•æ“æ‰§è¡Œã€‚
  
çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœè§‰å¾—ç´¯äº†ï¼Œå¯ä»¥å…ˆä¼‘æ¯ä¸‹ï¼Œè¿™äº›æ¦‚å¿µéœ€è¦è¢«æ¶ˆåŒ–ï¼Œæ¯•ç«Ÿåç»­å°†æåˆ°çš„äº‹ä»¶å¾ªç¯æœºåˆ¶å°±æ˜¯åŸºäº`äº‹ä»¶è§¦å‘çº¿ç¨‹`çš„ï¼Œæ‰€ä»¥å¦‚æœä»…ä»…æ˜¯çœ‹æŸä¸ªç¢ç‰‡åŒ–çŸ¥è¯†ï¼Œ
å¯èƒ½ä¼šæœ‰ä¸€ç§ä¼¼æ‡‚éæ‡‚çš„æ„Ÿè§‰ã€‚è¦å®Œæˆçš„æ¢³ç†ä¸€éæ‰èƒ½å¿«é€Ÿæ²‰æ·€ï¼Œä¸æ˜“é—å¿˜ã€‚æ”¾å¼ å›¾å·©å›ºä¸‹å§ï¼š

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/browser_inner_thread.png)

å†è¯´ä¸€ç‚¹ï¼Œä¸ºä»€ä¹ˆJSå¼•æ“æ˜¯å•çº¿ç¨‹çš„ï¼Ÿé¢ï¼Œè¿™ä¸ªé—®é¢˜å…¶å®åº”è¯¥æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œè­¬å¦‚ï¼Œå¯èƒ½ä»…ä»…æ˜¯å› ä¸ºç”±äºå¤šçº¿ç¨‹çš„å¤æ‚æ€§ï¼Œè­¬å¦‚å¤šçº¿ç¨‹æ“ä½œä¸€èˆ¬è¦åŠ é”ï¼Œå› æ­¤æœ€åˆè®¾è®¡æ—¶é€‰æ‹©äº†å•çº¿ç¨‹ã€‚ã€‚ã€‚

### Browserè¿›ç¨‹å’Œæµè§ˆå™¨å†…æ ¸ï¼ˆRendererè¿›ç¨‹ï¼‰çš„é€šä¿¡è¿‡ç¨‹

çœ‹åˆ°è¿™é‡Œï¼Œé¦–å…ˆï¼Œåº”è¯¥å¯¹æµè§ˆå™¨å†…çš„è¿›ç¨‹å’Œçº¿ç¨‹éƒ½æœ‰ä¸€å®šç†è§£äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œå†è°ˆè°ˆæµè§ˆå™¨çš„Browserè¿›ç¨‹ï¼ˆæ§åˆ¶è¿›ç¨‹ï¼‰æ˜¯å¦‚ä½•å’Œå†…æ ¸é€šä¿¡çš„ï¼Œ
è¿™ç‚¹ä¹Ÿç†è§£åï¼Œå°±å¯ä»¥å°†è¿™éƒ¨åˆ†çš„çŸ¥è¯†ä¸²è”èµ·æ¥ï¼Œä»å¤´åˆ°å°¾æœ‰ä¸€ä¸ªå®Œæ•´çš„æ¦‚å¿µã€‚

å¦‚æœè‡ªå·±æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨ï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨ï¼Œå°±å¯ä»¥çœ‹åˆ°ï¼š**ä»»åŠ¡ç®¡ç†å™¨ä¸­å‡ºç°äº†ä¸¤ä¸ªè¿›ç¨‹ï¼ˆä¸€ä¸ªæ˜¯ä¸»æ§è¿›ç¨‹ï¼Œä¸€ä¸ªåˆ™æ˜¯æ‰“å¼€Tabé¡µçš„æ¸²æŸ“è¿›ç¨‹ï¼‰**ï¼Œ
ç„¶ååœ¨è¿™å‰æä¸‹ï¼Œçœ‹ä¸‹æ•´ä¸ªçš„è¿‡ç¨‹ï¼š(ç®€åŒ–äº†å¾ˆå¤š)

- Browserè¿›ç¨‹æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œé¦–å…ˆéœ€è¦è·å–é¡µé¢å†…å®¹ï¼ˆè­¬å¦‚é€šè¿‡ç½‘ç»œä¸‹è½½èµ„æºï¼‰ï¼Œéšåå°†è¯¥ä»»åŠ¡é€šè¿‡RendererHostæ¥å£ä¼ é€’ç»™Renderè¿›ç¨‹

- Rendererè¿›ç¨‹çš„Rendereræ¥å£æ”¶åˆ°æ¶ˆæ¯ï¼Œç®€å•è§£é‡Šåï¼Œäº¤ç»™æ¸²æŸ“çº¿ç¨‹ï¼Œç„¶åå¼€å§‹æ¸²æŸ“

    - æ¸²æŸ“çº¿ç¨‹æ¥æ”¶è¯·æ±‚ï¼ŒåŠ è½½ç½‘é¡µå¹¶æ¸²æŸ“ç½‘é¡µï¼Œè¿™å…¶ä¸­å¯èƒ½éœ€è¦Browserè¿›ç¨‹è·å–èµ„æºå’Œéœ€è¦GPUè¿›ç¨‹æ¥å¸®åŠ©æ¸²æŸ“
    
    - å½“ç„¶å¯èƒ½ä¼šæœ‰JSçº¿ç¨‹æ“ä½œDOMï¼ˆè¿™æ ·å¯èƒ½ä¼šé€ æˆå›æµå¹¶é‡ç»˜ï¼‰
    
    - æœ€åRenderè¿›ç¨‹å°†ç»“æœä¼ é€’ç»™Browserè¿›ç¨‹
    
- Browserè¿›ç¨‹æ¥æ”¶åˆ°ç»“æœå¹¶å°†ç»“æœç»˜åˆ¶å‡ºæ¥  

è¿™é‡Œç»˜ä¸€å¼ ç®€å•çš„å›¾ï¼šï¼ˆå¾ˆç®€åŒ–ï¼‰

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/browser_rending_interact.png)

çœ‹å®Œè¿™ä¸€æ•´å¥—æµç¨‹ï¼Œåº”è¯¥å¯¹æµè§ˆå™¨çš„è¿ä½œæœ‰äº†ä¸€å®šç†è§£äº†ï¼Œè¿™æ ·æœ‰äº†çŸ¥è¯†æ¶æ„çš„åŸºç¡€åï¼Œåç»­å°±æ–¹ä¾¿å¾€ä¸Šå¡«å……å†…å®¹ã€‚

è¿™å—å†å¾€æ·±å¤„è®²çš„è¯å°±æ¶‰åŠåˆ°æµè§ˆå™¨å†…æ ¸æºç è§£æäº†ï¼Œä¸å±äºæœ¬æ–‡èŒƒå›´ã€‚

å¦‚æœè¿™ä¸€å—è¦æ·±æŒ–ï¼Œå»ºè®®å»è¯»ä¸€äº›æµè§ˆå™¨å†…æ ¸æºç è§£ææ–‡ç« ï¼Œæˆ–è€…å¯ä»¥å…ˆçœ‹çœ‹å‚è€ƒä¸‹æ¥æºä¸­çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå†™çš„ä¸é”™

## æ¢³ç†æµè§ˆå™¨å†…æ ¸ä¸­çº¿ç¨‹ä¹‹é—´çš„å…³ç³»

åˆ°äº†è¿™é‡Œï¼Œå·²ç»å¯¹æµè§ˆå™¨çš„è¿è¡Œæœ‰äº†ä¸€ä¸ªæ•´ä½“çš„æ¦‚å¿µï¼Œæ¥ä¸‹æ¥ï¼Œå…ˆç®€å•æ¢³ç†ä¸€äº›æ¦‚å¿µ

### GUIæ¸²æŸ“çº¿ç¨‹ä¸JSå¼•æ“çº¿ç¨‹äº’æ–¥

ç”±äºJavaScriptæ˜¯å¯æ“çºµDOMçš„ï¼Œå¦‚æœåœ¨ä¿®æ”¹è¿™äº›å…ƒç´ å±æ€§åŒæ—¶æ¸²æŸ“ç•Œé¢ï¼ˆå³JSçº¿ç¨‹å’ŒUIçº¿ç¨‹åŒæ—¶è¿è¡Œï¼‰ï¼Œé‚£ä¹ˆæ¸²æŸ“çº¿ç¨‹å‰åè·å¾—çš„å…ƒç´ æ•°æ®å°±å¯èƒ½ä¸ä¸€è‡´äº†ã€‚

å› æ­¤ä¸ºäº†é˜²æ­¢æ¸²æŸ“å‡ºç°ä¸å¯é¢„æœŸçš„ç»“æœï¼Œæµè§ˆå™¨è®¾ç½®GUIæ¸²æŸ“çº¿ç¨‹ä¸JSå¼•æ“ä¸ºäº’æ–¥çš„å…³ç³»ï¼Œå½“JSå¼•æ“æ‰§è¡Œæ—¶GUIçº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œ
GUIæ›´æ–°åˆ™ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ç­‰åˆ°JSå¼•æ“çº¿ç¨‹ç©ºé—²æ—¶ç«‹å³è¢«æ‰§è¡Œã€‚

### JSé˜»å¡é¡µé¢åŠ è½½

ä»ä¸Šè¿°çš„äº’æ–¥å…³ç³»ï¼Œå¯ä»¥æ¨å¯¼å‡ºï¼ŒJSå¦‚æœæ‰§è¡Œæ—¶é—´è¿‡é•¿å°±ä¼šé˜»å¡é¡µé¢ã€‚

è­¬å¦‚ï¼Œå‡è®¾JSå¼•æ“æ­£åœ¨è¿›è¡Œå·¨é‡çš„è®¡ç®—ï¼Œæ­¤æ—¶å°±ç®—GUIæœ‰æ›´æ–°ï¼Œä¹Ÿä¼šè¢«ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…JSå¼•æ“ç©ºé—²åæ‰§è¡Œã€‚
ç„¶åï¼Œç”±äºå·¨é‡è®¡ç®—ï¼Œæ‰€ä»¥JSå¼•æ“å¾ˆå¯èƒ½å¾ˆä¹…å¾ˆä¹…åæ‰èƒ½ç©ºé—²ï¼Œè‡ªç„¶ä¼šæ„Ÿè§‰åˆ°å·¨å¡æ— æ¯”ã€‚

æ‰€ä»¥ï¼Œè¦å°½é‡é¿å…JSæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¿™æ ·å°±ä¼šé€ æˆé¡µé¢çš„æ¸²æŸ“ä¸è¿è´¯ï¼Œå¯¼è‡´é¡µé¢æ¸²æŸ“åŠ è½½é˜»å¡çš„æ„Ÿè§‰ã€‚

### WebWorkerï¼ŒJSçš„å¤šçº¿ç¨‹ï¼Ÿ

å‰æ–‡ä¸­æœ‰æåˆ°JSå¼•æ“æ˜¯å•çº¿ç¨‹çš„ï¼Œè€Œä¸”JSæ‰§è¡Œæ—¶é—´è¿‡é•¿ä¼šé˜»å¡é¡µé¢ï¼Œé‚£ä¹ˆJSå°±çœŸçš„å¯¹cpuå¯†é›†å‹è®¡ç®—æ— èƒ½ä¸ºåŠ›ä¹ˆï¼Ÿ

æ‰€ä»¥ï¼Œåæ¥HTML5ä¸­æ”¯æŒäº†`Web Worker`ã€‚

MDNçš„å®˜æ–¹è§£é‡Šæ˜¯ï¼š

```js
Web Workerä¸ºWebå†…å®¹åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œè„šæœ¬æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ã€‚çº¿ç¨‹å¯ä»¥æ‰§è¡Œä»»åŠ¡è€Œä¸å¹²æ‰°ç”¨æˆ·ç•Œé¢

ä¸€ä¸ªworkeræ˜¯ä½¿ç”¨ä¸€ä¸ªæ„é€ å‡½æ•°åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡(e.g. Worker()) è¿è¡Œä¸€ä¸ªå‘½åçš„JavaScriptæ–‡ä»¶ 

è¿™ä¸ªæ–‡ä»¶åŒ…å«å°†åœ¨å·¥ä½œçº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç ; workers è¿è¡Œåœ¨å¦ä¸€ä¸ªå…¨å±€ä¸Šä¸‹æ–‡ä¸­,ä¸åŒäºå½“å‰çš„window

å› æ­¤ï¼Œä½¿ç”¨ windowå¿«æ·æ–¹å¼è·å–å½“å‰å…¨å±€çš„èŒƒå›´ (è€Œä¸æ˜¯self) åœ¨ä¸€ä¸ª Worker å†…å°†è¿”å›é”™è¯¯
```

è¿™æ ·ç†è§£ä¸‹ï¼š

- åˆ›å»ºWorkeræ—¶ï¼ŒJSå¼•æ“å‘æµè§ˆå™¨ç”³è¯·å¼€ä¸€ä¸ªå­çº¿ç¨‹ï¼ˆå­çº¿ç¨‹æ˜¯æµè§ˆå™¨å¼€çš„ï¼Œå®Œå…¨å—ä¸»çº¿ç¨‹æ§åˆ¶ï¼Œè€Œä¸”ä¸èƒ½æ“ä½œDOMï¼‰

- JSå¼•æ“çº¿ç¨‹ä¸workerçº¿ç¨‹é—´é€šè¿‡ç‰¹å®šçš„æ–¹å¼é€šä¿¡ï¼ˆpostMessage APIï¼Œéœ€è¦é€šè¿‡åºåˆ—åŒ–å¯¹è±¡æ¥ä¸çº¿ç¨‹äº¤äº’ç‰¹å®šçš„æ•°æ®ï¼‰

æ‰€ä»¥ï¼Œå¦‚æœæœ‰éå¸¸è€—æ—¶çš„å·¥ä½œï¼Œè¯·å•ç‹¬å¼€ä¸€ä¸ªWorkerçº¿ç¨‹ï¼Œè¿™æ ·é‡Œé¢ä¸ç®¡å¦‚ä½•ç¿»å¤©è¦†åœ°éƒ½ä¸ä¼šå½±å“JSå¼•æ“ä¸»çº¿ç¨‹ï¼Œ
åªå¾…è®¡ç®—å‡ºç»“æœåï¼Œå°†ç»“æœé€šä¿¡ç»™ä¸»çº¿ç¨‹å³å¯ï¼Œperfect!

è€Œä¸”æ³¨æ„ä¸‹ï¼Œ**JSå¼•æ“æ˜¯å•çº¿ç¨‹çš„**ï¼Œè¿™ä¸€ç‚¹çš„æœ¬è´¨ä»ç„¶æœªæ”¹å˜ï¼ŒWorkerå¯ä»¥ç†è§£æ˜¯æµè§ˆå™¨ç»™JSå¼•æ“å¼€çš„å¤–æŒ‚ï¼Œä¸“é—¨ç”¨æ¥è§£å†³é‚£äº›å¤§é‡è®¡ç®—é—®é¢˜ã€‚

å…¶å®ƒï¼Œå…³äºWorkerçš„è¯¦è§£å°±ä¸æ˜¯æœ¬æ–‡çš„èŒƒç•´äº†ï¼Œå› æ­¤ä¸å†èµ˜è¿°ã€‚

### WebWorkerä¸SharedWorker

æ—¢ç„¶éƒ½åˆ°äº†è¿™é‡Œï¼Œå°±å†æä¸€ä¸‹`SharedWorker`ï¼ˆé¿å…åç»­å°†è¿™ä¸¤ä¸ªæ¦‚å¿µææ··ï¼‰

- WebWorkeråªå±äºæŸä¸ªé¡µé¢ï¼Œä¸ä¼šå’Œå…¶ä»–é¡µé¢çš„Renderè¿›ç¨‹ï¼ˆæµè§ˆå™¨å†…æ ¸è¿›ç¨‹ï¼‰å…±äº«

    - æ‰€ä»¥Chromeåœ¨Renderè¿›ç¨‹ä¸­ï¼ˆæ¯ä¸€ä¸ªTabé¡µå°±æ˜¯ä¸€ä¸ªrenderè¿›ç¨‹ï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥è¿è¡ŒWorkerä¸­çš„JavaScriptç¨‹åºã€‚

- SharedWorkeræ˜¯æµè§ˆå™¨æ‰€æœ‰é¡µé¢å…±äº«çš„ï¼Œä¸èƒ½é‡‡ç”¨ä¸WorkeråŒæ ·çš„æ–¹å¼å®ç°ï¼Œå› ä¸ºå®ƒä¸éš¶å±äºæŸä¸ªRenderè¿›ç¨‹ï¼Œå¯ä»¥ä¸ºå¤šä¸ªRenderè¿›ç¨‹å…±äº«ä½¿ç”¨

    - æ‰€ä»¥Chromeæµè§ˆå™¨ä¸ºSharedWorkerå•ç‹¬åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡ŒJavaScriptç¨‹åºï¼Œåœ¨æµè§ˆå™¨ä¸­æ¯ä¸ªç›¸åŒçš„JavaScriptåªå­˜åœ¨ä¸€ä¸ªSharedWorkerè¿›ç¨‹ï¼Œä¸ç®¡å®ƒè¢«åˆ›å»ºå¤šå°‘æ¬¡ã€‚
    
çœ‹åˆ°è¿™é‡Œï¼Œåº”è¯¥å°±å¾ˆå®¹æ˜“æ˜ç™½äº†ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«ã€‚SharedWorkerç”±ç‹¬ç«‹çš„è¿›ç¨‹ç®¡ç†ï¼ŒWebWorkeråªæ˜¯å±äºrenderè¿›ç¨‹ä¸‹çš„ä¸€ä¸ªçº¿ç¨‹

## ç®€å•æ¢³ç†ä¸‹æµè§ˆå™¨æ¸²æŸ“æµç¨‹

æœ¬æ¥æ˜¯ç›´æ¥è®¡åˆ’å¼€å§‹è°ˆJSè¿è¡Œæœºåˆ¶çš„ï¼Œä½†æƒ³äº†æƒ³ï¼Œæ—¢ç„¶ä¸Šè¿°éƒ½ä¸€ç›´åœ¨è°ˆæµè§ˆå™¨ï¼Œç›´æ¥è·³åˆ°JSå¯èƒ½å†çªå…€ï¼Œå› æ­¤ï¼Œä¸­é—´å†è¡¥å……ä¸‹æµè§ˆå™¨çš„æ¸²æŸ“æµç¨‹ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰

ä¸ºäº†ç®€åŒ–ç†è§£ï¼Œå‰æœŸå·¥ä½œç›´æ¥çœç•¥æˆï¼šï¼ˆè¦å±•å¼€çš„æˆ–å®Œå…¨å¯ä»¥å†™å¦ä¸€ç¯‡è¶…é•¿æ–‡ï¼‰

```js
- æµè§ˆå™¨è¾“å…¥urlï¼Œæµè§ˆå™¨ä¸»è¿›ç¨‹æ¥ç®¡ï¼Œå¼€ä¸€ä¸ªä¸‹è½½çº¿ç¨‹ï¼Œ
ç„¶åè¿›è¡Œ httpè¯·æ±‚ï¼ˆç•¥å»DNSæŸ¥è¯¢ï¼ŒIPå¯»å€ç­‰ç­‰æ“ä½œï¼‰ï¼Œç„¶åç­‰å¾…å“åº”ï¼Œè·å–å†…å®¹ï¼Œ
éšåå°†å†…å®¹é€šè¿‡RendererHostæ¥å£è½¬äº¤ç»™Rendererè¿›ç¨‹

- æµè§ˆå™¨æ¸²æŸ“æµç¨‹å¼€å§‹
```

æµè§ˆå™¨å™¨å†…æ ¸æ‹¿åˆ°å†…å®¹åï¼Œæ¸²æŸ“å¤§æ¦‚å¯ä»¥åˆ’åˆ†æˆä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. è§£æhtmlå»ºç«‹domæ ‘

2. è§£æcssæ„å»ºrenderæ ‘ï¼ˆå°†CSSä»£ç è§£ææˆæ ‘å½¢çš„æ•°æ®ç»“æ„ï¼Œç„¶åç»“åˆDOMåˆå¹¶æˆrenderæ ‘ï¼‰

3. å¸ƒå±€renderæ ‘ï¼ˆLayout/reflowï¼‰ï¼Œè´Ÿè´£å„å…ƒç´ å°ºå¯¸ã€ä½ç½®çš„è®¡ç®—

4. ç»˜åˆ¶renderæ ‘ï¼ˆpaintï¼‰ï¼Œç»˜åˆ¶é¡µé¢åƒç´ ä¿¡æ¯

5. æµè§ˆå™¨ä¼šå°†å„å±‚çš„ä¿¡æ¯å‘é€ç»™GPUï¼ŒGPUä¼šå°†å„å±‚åˆæˆï¼ˆcompositeï¼‰ï¼Œæ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

æ‰€æœ‰è¯¦ç»†æ­¥éª¤éƒ½å·²ç»ç•¥å»ï¼Œæ¸²æŸ“å®Œæ¯•åå°±æ˜¯`load`äº‹ä»¶äº†ï¼Œä¹‹åå°±æ˜¯è‡ªå·±çš„JSé€»è¾‘å¤„ç†äº†

æ—¢ç„¶ç•¥å»äº†ä¸€äº›è¯¦ç»†çš„æ­¥éª¤ï¼Œé‚£ä¹ˆå°±æä¸€äº›å¯èƒ½éœ€è¦æ³¨æ„çš„ç»†èŠ‚æŠŠã€‚

è¿™é‡Œé‡ç»˜å‚è€ƒæ¥æºä¸­çš„ä¸€å¼ å›¾ï¼šï¼ˆå‚è€ƒæ¥æºç¬¬ä¸€ç¯‡ï¼‰

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/browser_rending.png)

### loadäº‹ä»¶ä¸DOMContentLoadedäº‹ä»¶çš„å…ˆå

ä¸Šé¢æåˆ°ï¼Œæ¸²æŸ“å®Œæ¯•åä¼šè§¦å‘`load`äº‹ä»¶ï¼Œé‚£ä¹ˆä½ èƒ½åˆ†æ¸…æ¥š`load`äº‹ä»¶ä¸`DOMContentLoaded`äº‹ä»¶çš„å…ˆåä¹ˆï¼Ÿ

å¾ˆç®€å•ï¼ŒçŸ¥é“å®ƒä»¬çš„å®šä¹‰å°±å¯ä»¥äº†ï¼š

- å½“ DOMContentLoaded äº‹ä»¶è§¦å‘æ—¶ï¼Œä»…å½“DOMåŠ è½½å®Œæˆï¼Œä¸åŒ…æ‹¬æ ·å¼è¡¨ï¼Œå›¾ç‰‡ã€‚
(è­¬å¦‚å¦‚æœæœ‰asyncåŠ è½½çš„è„šæœ¬å°±ä¸ä¸€å®šå®Œæˆ)

- å½“ onload äº‹ä»¶è§¦å‘æ—¶ï¼Œé¡µé¢ä¸Šæ‰€æœ‰çš„DOMï¼Œæ ·å¼è¡¨ï¼Œè„šæœ¬ï¼Œå›¾ç‰‡éƒ½å·²ç»åŠ è½½å®Œæˆäº†ã€‚
ï¼ˆæ¸²æŸ“å®Œæ¯•äº†ï¼‰

æ‰€ä»¥ï¼Œé¡ºåºæ˜¯ï¼š`DOMContentLoaded -> load`

### cssåŠ è½½æ˜¯å¦ä¼šé˜»å¡domæ ‘æ¸²æŸ“ï¼Ÿ

è¿™é‡Œè¯´çš„æ˜¯å¤´éƒ¨å¼•å…¥cssçš„æƒ…å†µ

é¦–å…ˆï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼š**cssæ˜¯ç”±å•ç‹¬çš„ä¸‹è½½çº¿ç¨‹å¼‚æ­¥ä¸‹è½½çš„ã€‚**

ç„¶åå†è¯´ä¸‹å‡ ä¸ªç°è±¡ï¼š

- cssåŠ è½½ä¸ä¼šé˜»å¡DOMæ ‘è§£æï¼ˆå¼‚æ­¥åŠ è½½æ—¶DOMç…§å¸¸æ„å»ºï¼‰

- ä½†ä¼šé˜»å¡renderæ ‘æ¸²æŸ“ï¼ˆæ¸²æŸ“æ—¶éœ€ç­‰cssåŠ è½½å®Œæ¯•ï¼Œå› ä¸ºrenderæ ‘éœ€è¦cssä¿¡æ¯ï¼‰

è¿™å¯èƒ½ä¹Ÿæ˜¯æµè§ˆå™¨çš„ä¸€ç§ä¼˜åŒ–æœºåˆ¶ã€‚

å› ä¸ºä½ åŠ è½½cssçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šä¿®æ”¹ä¸‹é¢DOMèŠ‚ç‚¹çš„æ ·å¼ï¼Œ
å¦‚æœcssåŠ è½½ä¸é˜»å¡renderæ ‘æ¸²æŸ“çš„è¯ï¼Œé‚£ä¹ˆå½“cssåŠ è½½å®Œä¹‹åï¼Œ
renderæ ‘å¯èƒ½åˆå¾—é‡æ–°é‡ç»˜æˆ–è€…å›æµäº†ï¼Œè¿™å°±é€ æˆäº†ä¸€äº›æ²¡æœ‰å¿…è¦çš„æŸè€—ã€‚
æ‰€ä»¥å¹²è„†å°±å…ˆæŠŠDOMæ ‘çš„ç»“æ„å…ˆè§£æå®Œï¼ŒæŠŠå¯ä»¥åšçš„å·¥ä½œåšå®Œï¼Œç„¶åç­‰ä½ cssåŠ è½½å®Œä¹‹åï¼Œ
åœ¨æ ¹æ®æœ€ç»ˆçš„æ ·å¼æ¥æ¸²æŸ“renderæ ‘ï¼Œè¿™ç§åšæ³•æ€§èƒ½æ–¹é¢ç¡®å®ä¼šæ¯”è¾ƒå¥½ä¸€ç‚¹ã€‚

### æ™®é€šå›¾å±‚å’Œå¤åˆå›¾å±‚

æ¸²æŸ“æ­¥éª¤ä¸­å°±æåˆ°äº†`composite`æ¦‚å¿µã€‚

å¯ä»¥ç®€å•çš„è¿™æ ·ç†è§£ï¼Œæµè§ˆå™¨æ¸²æŸ“çš„å›¾å±‚ä¸€èˆ¬åŒ…å«ä¸¤å¤§ç±»ï¼š`æ™®é€šå›¾å±‚`ä»¥åŠ`å¤åˆå›¾å±‚`

é¦–å…ˆï¼Œæ™®é€šæ–‡æ¡£æµå†…å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¤åˆå›¾å±‚ï¼ˆè¿™é‡Œç§°ä¸º`é»˜è®¤å¤åˆå±‚`ï¼Œé‡Œé¢ä¸ç®¡æ·»åŠ å¤šå°‘å…ƒç´ ï¼Œå…¶å®éƒ½æ˜¯åœ¨åŒä¸€ä¸ªå¤åˆå›¾å±‚ä¸­ï¼‰

å…¶æ¬¡ï¼Œabsoluteå¸ƒå±€ï¼ˆfixedä¹Ÿä¸€æ ·ï¼‰ï¼Œè™½ç„¶å¯ä»¥è„±ç¦»æ™®é€šæ–‡æ¡£æµï¼Œä½†å®ƒä»ç„¶å±äº`é»˜è®¤å¤åˆå±‚`ã€‚

ç„¶åï¼Œå¯ä»¥é€šè¿‡`ç¡¬ä»¶åŠ é€Ÿ`çš„æ–¹å¼ï¼Œå£°æ˜ä¸€ä¸ª`æ–°çš„å¤åˆå›¾å±‚`ï¼Œå®ƒä¼šå•ç‹¬åˆ†é…èµ„æº
ï¼ˆå½“ç„¶ä¹Ÿä¼šè„±ç¦»æ™®é€šæ–‡æ¡£æµï¼Œè¿™æ ·ä¸€æ¥ï¼Œä¸ç®¡è¿™ä¸ªå¤åˆå›¾å±‚ä¸­æ€ä¹ˆå˜åŒ–ï¼Œä¹Ÿä¸ä¼šå½±å“`é»˜è®¤å¤åˆå±‚`é‡Œçš„å›æµé‡ç»˜ï¼‰

å¯ä»¥ç®€å•ç†è§£ä¸‹ï¼š**GPUä¸­ï¼Œå„ä¸ªå¤åˆå›¾å±‚æ˜¯å•ç‹¬ç»˜åˆ¶çš„ï¼Œæ‰€ä»¥äº’ä¸å½±å“**ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæŸäº›åœºæ™¯ç¡¬ä»¶åŠ é€Ÿæ•ˆæœä¸€çº§æ£’

å¯ä»¥`Chromeæºç è°ƒè¯• -> More Tools -> Rendering -> Layer borders`ä¸­çœ‹åˆ°ï¼Œé»„è‰²çš„å°±æ˜¯å¤åˆå›¾å±‚ä¿¡æ¯

å¦‚ä¸‹å›¾ã€‚å¯ä»¥éªŒè¯ä¸Šè¿°çš„è¯´æ³•

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/css_speedup_layer.png)

__å¦‚ä½•å˜æˆå¤åˆå›¾å±‚ï¼ˆç¡¬ä»¶åŠ é€Ÿï¼‰__

å°†è¯¥å…ƒç´ å˜æˆä¸€ä¸ªå¤åˆå›¾å±‚ï¼Œå°±æ˜¯ä¼ è¯´ä¸­çš„ç¡¬ä»¶åŠ é€ŸæŠ€æœ¯

- æœ€å¸¸ç”¨çš„æ–¹å¼ï¼š`translate3d`ã€`translateZ`

- `opacity`å±æ€§/è¿‡æ¸¡åŠ¨ç”»ï¼ˆéœ€è¦åŠ¨ç”»æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ‰ä¼šåˆ›å»ºåˆæˆå±‚ï¼ŒåŠ¨ç”»æ²¡æœ‰å¼€å§‹æˆ–ç»“æŸåå…ƒç´ è¿˜ä¼šå›åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼‰

- `will-chang`å±æ€§ï¼ˆè¿™ä¸ªæ¯”è¾ƒååƒ»ï¼‰ï¼Œä¸€èˆ¬é…åˆopacityä¸translateä½¿ç”¨ï¼ˆè€Œä¸”ç»æµ‹è¯•ï¼Œé™¤äº†ä¸Šè¿°å¯ä»¥å¼•å‘ç¡¬ä»¶åŠ é€Ÿçš„å±æ€§å¤–ï¼Œå…¶å®ƒå±æ€§å¹¶ä¸ä¼šå˜æˆå¤åˆå±‚ï¼‰ï¼Œ
ä½œç”¨æ˜¯æå‰å‘Šè¯‰æµè§ˆå™¨è¦å˜åŒ–ï¼Œè¿™æ ·æµè§ˆå™¨ä¼šå¼€å§‹åšä¸€äº›ä¼˜åŒ–å·¥ä½œï¼ˆè¿™ä¸ªæœ€å¥½ç”¨å®Œåå°±é‡Šæ”¾ï¼‰

- `<video><iframe><canvas><webgl>`ç­‰å…ƒç´ 

- å…¶å®ƒï¼Œè­¬å¦‚ä»¥å‰çš„flashæ’ä»¶

__absoluteå’Œç¡¬ä»¶åŠ é€Ÿçš„åŒºåˆ«__

å¯ä»¥çœ‹åˆ°ï¼Œabsoluteè™½ç„¶å¯ä»¥è„±ç¦»æ™®é€šæ–‡æ¡£æµï¼Œä½†æ˜¯æ— æ³•è„±ç¦»é»˜è®¤å¤åˆå±‚ã€‚
æ‰€ä»¥ï¼Œå°±ç®—absoluteä¸­ä¿¡æ¯æ”¹å˜æ—¶ä¸ä¼šæ”¹å˜æ™®é€šæ–‡æ¡£æµä¸­renderæ ‘ï¼Œ
ä½†æ˜¯ï¼Œæµè§ˆå™¨æœ€ç»ˆç»˜åˆ¶æ—¶ï¼Œæ˜¯æ•´ä¸ªå¤åˆå±‚ç»˜åˆ¶çš„ï¼Œæ‰€ä»¥absoluteä¸­ä¿¡æ¯çš„æ”¹å˜ï¼Œä»ç„¶ä¼šå½±å“æ•´ä¸ªå¤åˆå±‚çš„ç»˜åˆ¶ã€‚
ï¼ˆæµè§ˆå™¨ä¼šé‡ç»˜å®ƒï¼Œå¦‚æœå¤åˆå±‚ä¸­å†…å®¹å¤šï¼Œabsoluteå¸¦æ¥çš„ç»˜åˆ¶ä¿¡æ¯å˜åŒ–è¿‡å¤§ï¼Œèµ„æºæ¶ˆè€—æ˜¯éå¸¸ä¸¥é‡çš„ï¼‰

è€Œç¡¬ä»¶åŠ é€Ÿç›´æ¥å°±æ˜¯åœ¨å¦ä¸€ä¸ªå¤åˆå±‚äº†ï¼ˆå¦èµ·ç‚‰ç¶ï¼‰ï¼Œæ‰€ä»¥å®ƒçš„ä¿¡æ¯æ”¹å˜ä¸ä¼šå½±å“é»˜è®¤å¤åˆå±‚
ï¼ˆå½“ç„¶äº†ï¼Œå†…éƒ¨è‚¯å®šä¼šå½±å“å±äºè‡ªå·±çš„å¤åˆå±‚ï¼‰ï¼Œä»…ä»…æ˜¯å¼•å‘æœ€åçš„åˆæˆï¼ˆè¾“å‡ºè§†å›¾ï¼‰

__å¤åˆå›¾å±‚çš„ä½œç”¨ï¼Ÿ__

ä¸€èˆ¬ä¸€ä¸ªå…ƒç´ å¼€å¯ç¡¬ä»¶åŠ é€Ÿåä¼šå˜æˆå¤åˆå›¾å±‚ï¼Œå¯ä»¥ç‹¬ç«‹äºæ™®é€šæ–‡æ¡£æµä¸­ï¼Œæ”¹åŠ¨åå¯ä»¥é¿å…æ•´ä¸ªé¡µé¢é‡ç»˜ï¼Œæå‡æ€§èƒ½

ä½†æ˜¯å°½é‡ä¸è¦å¤§é‡ä½¿ç”¨å¤åˆå›¾å±‚ï¼Œå¦åˆ™ç”±äºèµ„æºæ¶ˆè€—è¿‡åº¦ï¼Œé¡µé¢åè€Œä¼šå˜çš„æ›´å¡

__ç¡¬ä»¶åŠ é€Ÿæ—¶è¯·ä½¿ç”¨index__

ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿæ—¶ï¼Œå°½å¯èƒ½çš„ä½¿ç”¨indexï¼Œé˜²æ­¢æµè§ˆå™¨é»˜è®¤ç»™åç»­çš„å…ƒç´ åˆ›å»ºå¤åˆå±‚æ¸²æŸ“

å…·ä½“çš„åŸç†æ—¶è¿™æ ·çš„ï¼š
**webkit CSS3ä¸­ï¼Œå¦‚æœè¿™ä¸ªå…ƒç´ æ·»åŠ äº†ç¡¬ä»¶åŠ é€Ÿï¼Œå¹¶ä¸”indexå±‚çº§æ¯”è¾ƒä½ï¼Œ
é‚£ä¹ˆåœ¨è¿™ä¸ªå…ƒç´ çš„åé¢å…¶å®ƒå…ƒç´ ï¼ˆå±‚çº§æ¯”è¿™ä¸ªå…ƒç´ é«˜çš„ï¼Œæˆ–è€…ç›¸åŒçš„ï¼Œå¹¶ä¸”releativeæˆ–absoluteå±æ€§ç›¸åŒçš„ï¼‰ï¼Œ
ä¼šé»˜è®¤å˜ä¸ºå¤åˆå±‚æ¸²æŸ“ï¼Œå¦‚æœå¤„ç†ä¸å½“ä¼šæå¤§çš„å½±å“æ€§èƒ½**

ç®€å•ç‚¹ç†è§£ï¼Œå…¶å®å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªéšå¼åˆæˆçš„æ¦‚å¿µï¼š**å¦‚æœaæ˜¯ä¸€ä¸ªå¤åˆå›¾å±‚ï¼Œè€Œä¸”båœ¨aä¸Šé¢ï¼Œé‚£ä¹ˆbä¹Ÿä¼šè¢«éšå¼è½¬ä¸ºä¸€ä¸ªå¤åˆå›¾å±‚**ï¼Œè¿™ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„

å¦å¤–ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥åœ¨è¿™ä¸ªåœ°å€çœ‹åˆ°é‡ç°ï¼ˆåŸä½œè€…åˆ†æçš„æŒºåˆ°ä½çš„ï¼Œç›´æ¥ä¸Šé“¾æ¥ï¼‰ï¼š

[http://web.jobbole.com/83575/](http://web.jobbole.com/83575/)

## ä»Event Loopè°ˆJSçš„è¿è¡Œæœºåˆ¶

åˆ°æ­¤æ—¶ï¼Œå·²ç»æ˜¯å±äºæµè§ˆå™¨é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæ¯•åçš„äº‹æƒ…ï¼ŒJSå¼•æ“çš„ä¸€äº›è¿è¡Œæœºåˆ¶åˆ†æã€‚

æ³¨æ„ï¼Œè¿™é‡Œä¸è°ˆ`å¯æ‰§è¡Œä¸Šä¸‹æ–‡`ï¼Œ`VO`ï¼Œ`scop chain`ç­‰æ¦‚å¿µï¼ˆè¿™äº›å®Œå…¨å¯ä»¥æ•´ç†æˆå¦ä¸€ç¯‡æ–‡ç« äº†ï¼‰ï¼Œè¿™é‡Œä¸»è¦æ˜¯ç»“åˆ`Event Loop`æ¥è°ˆJSä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ã€‚

è¯»è¿™éƒ¨åˆ†çš„å‰ææ˜¯å·²ç»çŸ¥é“äº†JSå¼•æ“æ˜¯å•çº¿ç¨‹ï¼Œè€Œä¸”è¿™é‡Œä¼šç”¨åˆ°ä¸Šæ–‡ä¸­çš„å‡ ä¸ªæ¦‚å¿µï¼šï¼ˆå¦‚æœä¸æ˜¯å¾ˆç†è§£ï¼Œå¯ä»¥å›å¤´æ¸©ä¹ ï¼‰

- JSå¼•æ“çº¿ç¨‹

- äº‹ä»¶è§¦å‘çº¿ç¨‹

- å®šæ—¶è§¦å‘å™¨çº¿ç¨‹

ç„¶åå†ç†è§£ä¸€ä¸ªæ¦‚å¿µï¼š

- JSåˆ†ä¸ºåŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡

- åŒæ­¥ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ª`æ‰§è¡Œæ ˆ`

- ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œ**äº‹ä»¶è§¦å‘çº¿ç¨‹**ç®¡ç†ç€ä¸€ä¸ª`ä»»åŠ¡é˜Ÿåˆ—`ï¼Œåªè¦å¼‚æ­¥ä»»åŠ¡æœ‰äº†è¿è¡Œç»“æœï¼Œå°±åœ¨`ä»»åŠ¡é˜Ÿåˆ—`ä¹‹ä¸­æ”¾ç½®ä¸€ä¸ªäº‹ä»¶ã€‚

- ä¸€æ—¦`æ‰§è¡Œæ ˆ`ä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼ˆæ­¤æ—¶JSå¼•æ“ç©ºé—²ï¼‰ï¼Œç³»ç»Ÿå°±ä¼šè¯»å–`ä»»åŠ¡é˜Ÿåˆ—`ï¼Œå°†å¯è¿è¡Œçš„å¼‚æ­¥ä»»åŠ¡æ·»åŠ åˆ°å¯æ‰§è¡Œæ ˆä¸­ï¼Œå¼€å§‹æ‰§è¡Œã€‚

çœ‹å›¾ï¼š

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/js_event_loop.png)

çœ‹åˆ°è¿™é‡Œï¼Œåº”è¯¥å°±å¯ä»¥ç†è§£äº†ï¼šä¸ºä»€ä¹ˆæœ‰æ—¶å€™setTimeoutæ¨å…¥çš„äº‹ä»¶ä¸èƒ½å‡†æ—¶æ‰§è¡Œï¼Ÿå› ä¸ºå¯èƒ½åœ¨å®ƒæ¨å…¥åˆ°äº‹ä»¶åˆ—è¡¨æ—¶ï¼Œä¸»çº¿ç¨‹è¿˜ä¸ç©ºé—²ï¼Œæ­£åœ¨æ‰§è¡Œå…¶å®ƒä»£ç ï¼Œ
æ‰€ä»¥è‡ªç„¶æœ‰è¯¯å·®ã€‚

### äº‹ä»¶å¾ªç¯æœºåˆ¶è¿›ä¸€æ­¥è¡¥å……

è¿™é‡Œå°±ç›´æ¥å¼•ç”¨ä¸€å¼ å›¾ç‰‡æ¥ååŠ©ç†è§£ï¼šï¼ˆå‚è€ƒè‡ªPhilip Robertsçš„æ¼”è®²ã€Š[Help, I'm stuck in an event-loop](http://vimeo.com/96425312)ã€‹ï¼‰

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/js_event_loop2.png)

ä¸Šå›¾å¤§è‡´æè¿°å°±æ˜¯ï¼š

- ä¸»çº¿ç¨‹è¿è¡Œæ—¶ä¼šäº§ç”Ÿæ‰§è¡Œæ ˆï¼Œ
æ ˆä¸­çš„ä»£ç è°ƒç”¨æŸäº›apiæ—¶ï¼Œå®ƒä»¬ä¼šåœ¨äº‹ä»¶é˜Ÿåˆ—ä¸­æ·»åŠ å„ç§äº‹ä»¶ï¼ˆå½“æ»¡è¶³è§¦å‘æ¡ä»¶åï¼Œå¦‚ajaxè¯·æ±‚å®Œæ¯•ï¼‰

- è€Œæ ˆä¸­çš„ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå°±ä¼šè¯»å–äº‹ä»¶é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œå»æ‰§è¡Œé‚£äº›å›è°ƒ

- å¦‚æ­¤å¾ªç¯

- æ³¨æ„ï¼Œæ€»æ˜¯è¦ç­‰å¾…æ ˆä¸­çš„ä»£ç æ‰§è¡Œå®Œæ¯•åæ‰ä¼šå»è¯»å–äº‹ä»¶é˜Ÿåˆ—ä¸­çš„äº‹ä»¶

### å•ç‹¬è¯´è¯´å®šæ—¶å™¨

ä¸Šè¿°äº‹ä»¶å¾ªç¯æœºåˆ¶çš„æ ¸å¿ƒæ˜¯ï¼šJSå¼•æ“çº¿ç¨‹å’Œäº‹ä»¶è§¦å‘çº¿ç¨‹

ä½†äº‹ä»¶ä¸Šï¼Œé‡Œé¢è¿˜æœ‰ä¸€äº›éšè—ç»†èŠ‚ï¼Œè­¬å¦‚è°ƒç”¨`setTimeout`åï¼Œæ˜¯å¦‚ä½•ç­‰å¾…ç‰¹å®šæ—¶é—´åæ‰æ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­çš„ï¼Ÿ

æ˜¯JSå¼•æ“æ£€æµ‹çš„ä¹ˆï¼Ÿå½“ç„¶ä¸æ˜¯äº†ã€‚å®ƒæ˜¯ç”±**å®šæ—¶å™¨çº¿ç¨‹**æ§åˆ¶ï¼ˆå› ä¸ºJSå¼•æ“è‡ªå·±éƒ½å¿™ä¸è¿‡æ¥ï¼Œæ ¹æœ¬æ— æš‡åˆ†èº«ï¼‰

ä¸ºä»€ä¹ˆè¦å•ç‹¬çš„å®šæ—¶å™¨çº¿ç¨‹ï¼Ÿå› ä¸ºJavaScriptå¼•æ“æ˜¯å•çº¿ç¨‹çš„, å¦‚æœå¤„äºé˜»å¡çº¿ç¨‹çŠ¶æ€å°±ä¼šå½±å“è®°è®¡æ—¶çš„å‡†ç¡®ï¼Œå› æ­¤å¾ˆæœ‰å¿…è¦å•ç‹¬å¼€ä¸€ä¸ªçº¿ç¨‹ç”¨æ¥è®¡æ—¶ã€‚

ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°å®šæ—¶å™¨çº¿ç¨‹ï¼Ÿ**å½“ä½¿ç”¨`setTimeout`æˆ–`setInterval`æ—¶**ï¼Œå®ƒéœ€è¦å®šæ—¶å™¨çº¿ç¨‹è®¡æ—¶ï¼Œè®¡æ—¶å®Œæˆåå°±ä¼šå°†ç‰¹å®šçš„äº‹ä»¶æ¨å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚

è­¬å¦‚:

```js
setTimeout(function(){
    console.log('hello!');
}, 1000);
```

è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯å½“`1000`æ¯«ç§’è®¡æ—¶å®Œæ¯•åï¼ˆç”±å®šæ—¶å™¨çº¿ç¨‹è®¡æ—¶ï¼‰ï¼Œå°†å›è°ƒå‡½æ•°æ¨å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸»çº¿ç¨‹æ‰§è¡Œ

```js
setTimeout(function(){
    console.log('hello!');
}, 0);

console.log('begin');
```

è¿™æ®µä»£ç çš„æ•ˆæœæ˜¯æœ€å¿«çš„æ—¶é—´å†…å°†å›è°ƒå‡½æ•°æ¨å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸»çº¿ç¨‹æ‰§è¡Œ

æ³¨æ„ï¼š

- æ‰§è¡Œç»“æœæ˜¯ï¼šå…ˆ`begin`å`hello!`

- è™½ç„¶ä»£ç çš„æœ¬æ„æ˜¯0æ¯«ç§’åå°±æ¨å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œä½†æ˜¯W3Cåœ¨HTMLæ ‡å‡†ä¸­è§„å®šï¼Œè§„å®šè¦æ±‚setTimeoutä¸­ä½äº4msçš„æ—¶é—´é—´éš”ç®—ä¸º4msã€‚
(ä¸è¿‡ä¹Ÿæœ‰ä¸€è¯´æ˜¯ä¸åŒæµè§ˆå™¨æœ‰ä¸åŒçš„æœ€å°æ—¶é—´è®¾å®š)

- å°±ç®—ä¸ç­‰å¾…4msï¼Œå°±ç®—å‡è®¾0æ¯«ç§’å°±æ¨å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œä¹Ÿä¼šå…ˆæ‰§è¡Œ`begin`ï¼ˆå› ä¸ºåªæœ‰å¯æ‰§è¡Œæ ˆå†…ç©ºäº†åæ‰ä¼šä¸»åŠ¨è¯»å–äº‹ä»¶é˜Ÿåˆ—ï¼‰

### setTimeoutè€Œä¸æ˜¯setInterval

ç”¨setTimeoutæ¨¡æ‹Ÿå®šæœŸè®¡æ—¶å’Œç›´æ¥ç”¨setIntervalæ˜¯æœ‰åŒºåˆ«çš„ã€‚

å› ä¸ºæ¯æ¬¡setTimeoutè®¡æ—¶åˆ°åå°±ä¼šå»æ‰§è¡Œï¼Œç„¶åæ‰§è¡Œä¸€æ®µæ—¶é—´åæ‰ä¼šç»§ç»­setTimeoutï¼Œä¸­é—´å°±å¤šäº†è¯¯å·®
ï¼ˆè¯¯å·®å¤šå°‘ä¸ä»£ç æ‰§è¡Œæ—¶é—´æœ‰å…³ï¼‰

è€ŒsetIntervalåˆ™æ˜¯æ¯æ¬¡éƒ½ç²¾ç¡®çš„éš”ä¸€æ®µæ—¶é—´æ¨å…¥ä¸€ä¸ªäº‹ä»¶
ï¼ˆä½†æ˜¯ï¼Œäº‹ä»¶çš„å®é™…æ‰§è¡Œæ—¶é—´ä¸ä¸€å®šå°±å‡†ç¡®ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯è¿™ä¸ªäº‹ä»¶è¿˜æ²¡æ‰§è¡Œå®Œæ¯•ï¼Œä¸‹ä¸€ä¸ªäº‹ä»¶å°±æ¥äº†ï¼‰

è€Œä¸”setIntervalæœ‰ä¸€äº›æ¯”è¾ƒè‡´å‘½çš„é—®é¢˜å°±æ˜¯ï¼š

- ç´¯è®¡æ•ˆåº”ï¼ˆä¸Šé¢æåˆ°çš„ï¼‰ï¼Œå¦‚æœsetIntervalä»£ç åœ¨ï¼ˆsetIntervalï¼‰å†æ¬¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰è¿˜æ²¡æœ‰å®Œæˆæ‰§è¡Œï¼Œ
å°±ä¼šå¯¼è‡´å®šæ—¶å™¨ä»£ç è¿ç»­è¿è¡Œå¥½å‡ æ¬¡ï¼Œè€Œä¹‹é—´æ²¡æœ‰é—´éš”ã€‚
å°±ç®—æ­£å¸¸é—´éš”æ‰§è¡Œï¼Œå¤šä¸ªsetIntervalçš„ä»£ç æ‰§è¡Œæ—¶é—´å¯èƒ½ä¼šæ¯”é¢„æœŸå°ï¼ˆå› ä¸ºä»£ç æ‰§è¡Œéœ€è¦ä¸€å®šæ—¶é—´ï¼‰

- ~~è­¬å¦‚åƒiOSçš„webview,æˆ–è€…Safariç­‰æµè§ˆå™¨ä¸­éƒ½æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œ**åœ¨æ»šåŠ¨çš„æ—¶å€™æ˜¯ä¸æ‰§è¡ŒJSçš„**ï¼Œ
å¦‚æœä½¿ç”¨äº†setIntervalï¼Œä¼šå‘ç°åœ¨æ»šåŠ¨ç»“æŸåä¼šæ‰§è¡Œå¤šæ¬¡ç”±äºæ»šåŠ¨ä¸æ‰§è¡ŒJSç§¯æ”’å›è°ƒï¼Œ
å¦‚æœå›è°ƒæ‰§è¡Œæ—¶é—´è¿‡é•¿,å°±ä¼šéå¸¸å®¹å™¨é€ æˆå¡é¡¿é—®é¢˜å’Œä¸€äº›ä¸å¯çŸ¥çš„é”™è¯¯~~
ï¼ˆè¿™ä¸€å—åç»­æœ‰è¡¥å……ï¼ŒsetIntervalè‡ªå¸¦çš„ä¼˜åŒ–ï¼Œä¸ä¼šé‡å¤æ·»åŠ å›è°ƒï¼‰

- è€Œä¸”æŠŠæµè§ˆå™¨æœ€å°åŒ–æ˜¾ç¤ºç­‰æ“ä½œæ—¶ï¼ŒsetIntervalå¹¶ä¸æ˜¯ä¸æ‰§è¡Œç¨‹åºï¼Œ
å®ƒä¼šæŠŠsetIntervalçš„å›è°ƒå‡½æ•°æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œç­‰æµè§ˆå™¨çª—å£å†æ¬¡æ‰“å¼€æ—¶ï¼Œä¸€ç¬é—´å…¨éƒ¨æ‰§è¡Œæ—¶

æ‰€ä»¥ï¼Œé‰´äºè¿™ä¹ˆå¤šä½†é—®é¢˜ï¼Œç›®å‰ä¸€èˆ¬è®¤ä¸ºçš„æœ€ä½³æ–¹æ¡ˆæ˜¯ï¼š**ç”¨setTimeoutæ¨¡æ‹ŸsetIntervalï¼Œæˆ–è€…ç‰¹æ®Šåœºåˆç›´æ¥ç”¨requestAnimationFrame**

__è¡¥å……ï¼šJSé«˜ç¨‹ä¸­æœ‰æåˆ°ï¼ŒJSå¼•æ“ä¼šå¯¹setIntervalè¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰äº‹ä»¶é˜Ÿåˆ—ä¸­æœ‰setIntervalçš„å›è°ƒï¼Œä¸ä¼šé‡å¤æ·»åŠ ã€‚ä¸è¿‡ï¼Œä»ç„¶æ˜¯æœ‰å¾ˆå¤šé—®é¢˜ã€‚ã€‚ã€‚__

## äº‹ä»¶å¾ªç¯è¿›é˜¶ï¼šmacrotaskä¸microtask

è¿™æ®µå‚è€ƒäº†å‚è€ƒæ¥æºä¸­çš„ç¬¬2ç¯‡æ–‡ç« ï¼ˆè‹±æ–‡ç‰ˆçš„ï¼‰ï¼Œï¼ˆåŠ äº†ä¸‹è‡ªå·±çš„ç†è§£é‡æ–°æè¿°äº†ä¸‹ï¼‰ï¼Œ
å¼ºçƒˆæ¨èæœ‰è‹±æ–‡åŸºç¡€çš„åŒå­¦ç›´æ¥è§‚çœ‹åŸæ–‡ï¼Œä½œè€…æè¿°çš„å¾ˆæ¸…æ™°ï¼Œç¤ºä¾‹ä¹Ÿå¾ˆä¸é”™ï¼Œå¦‚ä¸‹ï¼š

[https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)

ä¸Šæ–‡ä¸­å°†JSäº‹ä»¶å¾ªç¯æœºåˆ¶æ¢³ç†äº†ä¸€éï¼Œåœ¨ES5çš„æƒ…å†µæ˜¯å¤Ÿç”¨äº†ï¼Œä½†æ˜¯åœ¨ES6ç››è¡Œçš„ç°åœ¨ï¼Œä»ç„¶ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œè­¬å¦‚ä¸‹é¢è¿™é¢˜ï¼š

```js
console.log('script start');

setTimeout(function() {
    console.log('setTimeout');
}, 0);

Promise.resolve().then(function() {
    console.log('promise1');
}).then(function() {
    console.log('promise2');
});

console.log('script end');
```

å—¯å“¼ï¼Œå®ƒçš„æ­£ç¡®æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·å­çš„ï¼š

```js
script start
script end
promise1
promise2
setTimeout
```

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºPromiseé‡Œæœ‰äº†ä¸€ä¸ªä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼š`microtask`

æˆ–è€…ï¼Œè¿›ä¸€æ­¥ï¼ŒJSä¸­åˆ†ä¸ºä¸¤ç§ä»»åŠ¡ç±»å‹ï¼š**`macrotask`å’Œ`microtask`**ï¼Œåœ¨ECMAScriptä¸­ï¼Œmicrotaskç§°ä¸º`jobs`ï¼Œmacrotaskå¯ç§°ä¸º`task`

å®ƒä»¬çš„å®šä¹‰ï¼ŸåŒºåˆ«ï¼Ÿç®€å•ç‚¹å¯ä»¥æŒ‰å¦‚ä¸‹ç†è§£ï¼š

- macrotaskï¼ˆåˆç§°ä¹‹ä¸ºå®ä»»åŠ¡ï¼‰ï¼Œå¯ä»¥ç†è§£æ˜¯æ¯æ¬¡æ‰§è¡Œæ ˆæ‰§è¡Œçš„ä»£ç å°±æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ¯æ¬¡ä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªäº‹ä»¶å›è°ƒå¹¶æ”¾åˆ°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œï¼‰

    - æ¯ä¸€ä¸ªtaskä¼šä»å¤´åˆ°å°¾å°†è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä¸ä¼šæ‰§è¡Œå…¶å®ƒ
    
    - æµè§ˆå™¨ä¸ºäº†èƒ½å¤Ÿä½¿å¾—JSå†…éƒ¨taskä¸DOMä»»åŠ¡èƒ½å¤Ÿæœ‰åºçš„æ‰§è¡Œï¼Œä¼šåœ¨ä¸€ä¸ªtaskæ‰§è¡Œç»“æŸåï¼Œåœ¨ä¸‹ä¸€ä¸ª task æ‰§è¡Œå¼€å§‹å‰ï¼Œå¯¹é¡µé¢è¿›è¡Œé‡æ–°æ¸²æŸ“
    ï¼ˆ`task->æ¸²æŸ“->task->...`ï¼‰
    
- microtaskï¼ˆåˆç§°ä¸ºå¾®ä»»åŠ¡ï¼‰ï¼Œå¯ä»¥ç†è§£æ˜¯åœ¨å½“å‰ task æ‰§è¡Œç»“æŸåç«‹å³æ‰§è¡Œçš„ä»»åŠ¡

    - ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å½“å‰taskä»»åŠ¡åï¼Œä¸‹ä¸€ä¸ªtaskä¹‹å‰ï¼Œåœ¨æ¸²æŸ“ä¹‹å‰
    
    - æ‰€ä»¥å®ƒçš„å“åº”é€Ÿåº¦ç›¸æ¯”setTimeoutï¼ˆsetTimeoutæ˜¯taskï¼‰ä¼šæ›´å¿«ï¼Œå› ä¸ºæ— éœ€ç­‰æ¸²æŸ“
    
    - ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æŸä¸€ä¸ªmacrotaskæ‰§è¡Œå®Œåï¼Œå°±ä¼šå°†åœ¨å®ƒæ‰§è¡ŒæœŸé—´äº§ç”Ÿçš„æ‰€æœ‰microtaskéƒ½æ‰§è¡Œå®Œæ¯•ï¼ˆåœ¨æ¸²æŸ“å‰ï¼‰
    

åˆ†åˆ«å¾ˆä¹ˆæ ·çš„åœºæ™¯ä¼šå½¢æˆmacrotaskå’Œmicrotaskå‘¢ï¼Ÿ

- macrotaskï¼šä¸»ä»£ç å—ï¼ŒsetTimeoutï¼ŒsetIntervalç­‰ï¼ˆå¯ä»¥çœ‹åˆ°ï¼Œäº‹ä»¶é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªäº‹ä»¶éƒ½æ˜¯ä¸€ä¸ªmacrotaskï¼‰

- microtaskï¼šPromiseï¼Œprocess.nextTickç­‰


__è¡¥å……ï¼šåœ¨nodeç¯å¢ƒä¸‹ï¼Œprocess.nextTickçš„ä¼˜å…ˆçº§é«˜äºPromise__ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç®€å•ç†è§£ä¸ºï¼šåœ¨å®ä»»åŠ¡ç»“æŸåä¼šå…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„nextTickQueueéƒ¨åˆ†ï¼Œç„¶åæ‰ä¼šæ‰§è¡Œå¾®ä»»åŠ¡ä¸­çš„Promiseéƒ¨åˆ†ã€‚

å¦å¤–ï¼ŒsetImmediateåˆ™æ˜¯è§„å®šï¼šåœ¨ä¸‹ä¸€æ¬¡Event Loopï¼ˆå®ä»»åŠ¡ï¼‰æ—¶è§¦å‘ï¼ˆæ‰€ä»¥å®ƒæ˜¯å±äºä¼˜å…ˆçº§è¾ƒé«˜çš„å®ä»»åŠ¡ï¼‰ï¼Œ
ï¼ˆNode.jsæ–‡æ¡£ä¸­ç§°ï¼ŒsetImmediateæŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œæ€»æ˜¯æ’åœ¨setTimeoutå‰é¢ï¼‰ï¼Œ
æ‰€ä»¥setImmediateå¦‚æœåµŒå¥—çš„è¯ï¼Œæ˜¯éœ€è¦ç»è¿‡å¤šä¸ªLoopæ‰èƒ½å®Œæˆçš„ï¼Œ
è€Œä¸ä¼šåƒprocess.nextTickä¸€æ ·æ²¡å®Œæ²¡äº†ã€‚

å‚è€ƒï¼š[https://segmentfault.com/q/1010000011914016](https://segmentfault.com/q/1010000011914016)
    
å†æ ¹æ®çº¿ç¨‹æ¥ç†è§£ä¸‹ï¼š

- macrotaskä¸­çš„äº‹ä»¶éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªäº‹ä»¶é˜Ÿåˆ—ä¸­çš„ï¼Œè€Œè¿™ä¸ªé˜Ÿåˆ—ç”±**äº‹ä»¶è§¦å‘çº¿ç¨‹**ç»´æŠ¤

- microtaskä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡éƒ½æ˜¯æ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆJob Queuesï¼‰ä¸­ï¼Œç­‰å¾…å½“å‰macrotaskæ‰§è¡Œå®Œæ¯•åæ‰§è¡Œï¼Œè€Œè¿™ä¸ªé˜Ÿåˆ—ç”±**JSå¼•æ“çº¿ç¨‹ç»´æŠ¤**
ï¼ˆè¿™ç‚¹ç”±è‡ªå·±ç†è§£+æ¨æµ‹å¾—å‡ºï¼Œå› ä¸ºå®ƒæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸‹æ— ç¼æ‰§è¡Œçš„ï¼‰

æ‰€ä»¥ï¼Œæ€»ç»“ä¸‹è¿è¡Œæœºåˆ¶ï¼š

- æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆæ ˆä¸­æ²¡æœ‰å°±ä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ï¼‰

- æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¾®ä»»åŠ¡ï¼Œå°±å°†å®ƒæ·»åŠ åˆ°å¾®ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­

- å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œå½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰

- å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ£€æŸ¥æ¸²æŸ“ï¼Œç„¶åGUIçº¿ç¨‹æ¥ç®¡æ¸²æŸ“

- æ¸²æŸ“å®Œæ¯•åï¼ŒJSçº¿ç¨‹ç»§ç»­æ¥ç®¡ï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ï¼‰

å¦‚å›¾ï¼š

![](https://dailc.github.io/staticResource/blog/basicKnowledge/singlethreadeventloop/js_macrotask_microtask.png)

å¦å¤–ï¼Œè¯·æ³¨æ„ä¸‹`Promise`çš„`polyfill`ä¸å®˜æ–¹ç‰ˆæœ¬çš„åŒºåˆ«ï¼š

- å®˜æ–¹ç‰ˆæœ¬ä¸­ï¼Œæ˜¯æ ‡å‡†çš„microtaskå½¢å¼

- polyfillï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡setTimeoutæ¨¡æ‹Ÿçš„ï¼Œæ‰€ä»¥æ˜¯macrotaskå½¢å¼

- è¯·ç‰¹åˆ«æ³¨æ„è¿™ä¸¤ç‚¹åŒºåˆ«

æ³¨æ„ï¼Œæœ‰ä¸€äº›æµè§ˆå™¨æ‰§è¡Œç»“æœä¸ä¸€æ ·ï¼ˆå› ä¸ºå®ƒä»¬å¯èƒ½æŠŠmicrotaskå½“æˆmacrotaskæ¥æ‰§è¡Œäº†ï¼‰ï¼Œ
ä½†æ˜¯ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œä¸æè¿°ä¸€äº›ä¸æ ‡å‡†çš„æµè§ˆå™¨ä¸‹çš„åœºæ™¯ï¼ˆä½†è®°ä½ï¼Œæœ‰äº›æµè§ˆå™¨å¯èƒ½å¹¶ä¸æ ‡å‡†ï¼‰

__20180126è¡¥å……ï¼šä½¿ç”¨MutationObserverå®ç°microtask__

MutationObserverå¯ä»¥ç”¨æ¥å®ç°microtask
ï¼ˆå®ƒå±äºmicrotaskï¼Œä¼˜å…ˆçº§å°äºPromiseï¼Œ
ä¸€èˆ¬æ˜¯Promiseä¸æ”¯æŒæ—¶æ‰ä¼šè¿™æ ·åšï¼‰

å®ƒæ˜¯HTML5ä¸­çš„æ–°ç‰¹æ€§ï¼Œä½œç”¨æ˜¯ï¼šç›‘å¬ä¸€ä¸ªDOMå˜åŠ¨ï¼Œ
å½“DOMå¯¹è±¡æ ‘å‘ç”Ÿä»»ä½•å˜åŠ¨æ—¶ï¼ŒMutation Observerä¼šå¾—åˆ°é€šçŸ¥

åƒä»¥å‰çš„Vueæºç ä¸­å°±æ˜¯åˆ©ç”¨å®ƒæ¥æ¨¡æ‹ŸnextTickçš„ï¼Œ
å…·ä½“åŸç†æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªTextNodeå¹¶ç›‘å¬å†…å®¹å˜åŒ–ï¼Œ
ç„¶åè¦nextTickçš„æ—¶å€™å»æ”¹ä¸€ä¸‹è¿™ä¸ªèŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹ï¼Œ
å¦‚ä¸‹ï¼šï¼ˆVueçš„æºç ï¼Œæœªä¿®æ”¹ï¼‰

```js
var counter = 1
var observer = new MutationObserver(nextTickHandler)
var textNode = document.createTextNode(String(counter))

observer.observe(textNode, {
    characterData: true
})
timerFunc = () => {
    counter = (counter + 1) % 2
    textNode.data = String(counter)
}
```

[å¯¹åº”Vueæºç é“¾æ¥](https://github.com/vuejs/vue/blob/9cfd63a7d08c1eba029c8bd7463b3047c3347826/src/core/util/env.js#L86-L95)

ä¸è¿‡ï¼Œç°åœ¨çš„Vueï¼ˆ2.5+ï¼‰çš„nextTickå®ç°ç§»é™¤äº†MutationObserverçš„æ–¹å¼ï¼ˆæ®è¯´æ˜¯å…¼å®¹æ€§åŸå› ï¼‰ï¼Œ
å–è€Œä»£ä¹‹çš„æ˜¯ä½¿ç”¨MessageChannel
ï¼ˆå½“ç„¶ï¼Œé»˜è®¤æƒ…å†µä»ç„¶æ˜¯Promiseï¼Œä¸æ”¯æŒæ‰å…¼å®¹çš„ï¼‰ã€‚

MessageChannelå±äºå®ä»»åŠ¡ï¼Œä¼˜å…ˆçº§æ˜¯ï¼š`MessageChannel->setTimeout`ï¼Œ
æ‰€ä»¥Vueï¼ˆ2.5+ï¼‰å†…éƒ¨çš„nextTickä¸2.4åŠä¹‹å‰çš„å®ç°æ˜¯ä¸ä¸€æ ·çš„ï¼Œéœ€è¦æ³¨æ„ä¸‹ã€‚

è¿™é‡Œä¸å±•å¼€ï¼Œå¯ä»¥çœ‹ä¸‹[https://juejin.im/post/5a1af88f5188254a701ec230](https://juejin.im/post/5a1af88f5188254a701ec230)

## å†™åœ¨æœ€åçš„è¯

çœ‹åˆ°è¿™é‡Œï¼Œä¸çŸ¥é“å¯¹JSçš„è¿è¡Œæœºåˆ¶æ˜¯ä¸æ˜¯æ›´åŠ ç†è§£äº†ï¼Œä»å¤´åˆ°å°¾æ¢³ç†ï¼Œè€Œä¸æ˜¯å°±æŸä¸€ä¸ªç¢ç‰‡åŒ–çŸ¥è¯†åº”è¯¥æ˜¯ä¼šæ›´æ¸…æ™°çš„å§ï¼Ÿ

åŒæ—¶ï¼Œä¹Ÿåº”è¯¥æ³¨æ„åˆ°äº†JSæ ¹æœ¬å°±æ²¡æœ‰æƒ³è±¡çš„é‚£ä¹ˆç®€å•ï¼Œå‰ç«¯çš„çŸ¥è¯†ä¹Ÿæ˜¯æ— ç©·æ— å°½ï¼Œå±‚å‡ºä¸ç©·çš„æ¦‚å¿µã€Nå¤šæ˜“å¿˜çš„çŸ¥è¯†ç‚¹ã€å„å¼å„æ ·çš„æ¡†æ¶ã€
åº•å±‚åŸç†æ–¹é¢ä¹Ÿæ˜¯å¯ä»¥æ— é™çš„å¾€ä¸‹æ·±æŒ–ï¼Œç„¶åä½ å°±ä¼šå‘ç°ï¼Œä½ çŸ¥é“çš„å¤ªå°‘äº†ã€‚ã€‚ã€‚

å¦å¤–ï¼Œæœ¬æ–‡ä¹Ÿæ‰“ç®—å…ˆå‘Šä¸€æ®µè½ï¼Œå…¶å®ƒçš„ï¼Œå¦‚JSè¯æ³•è§£æï¼Œå¯æ‰§è¡Œä¸Šä¸‹æ–‡ä»¥åŠVOç­‰æ¦‚å¿µå°±ä¸ç»§ç»­åœ¨æœ¬æ–‡ä¸­å†™äº†ï¼Œåç»­å¯ä»¥è€ƒè™‘å¦å¼€æ–°çš„æ–‡ç« ã€‚

æœ€åï¼Œå–œæ¬¢çš„è¯ï¼Œå°±è¯·ç»™ä¸ªèµå§ï¼

## é™„å½•

### åšå®¢

åˆæ¬¡å‘å¸ƒ`2018.01.21`äºæˆ‘ä¸ªäººåšå®¢ä¸Šé¢

[http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html](http://www.dailichun.com/2018/01/21/js_singlethread_eventloop.html)


### å‚è€ƒèµ„æ–™

- [https://www.cnblogs.com/lhb25/p/how-browsers-work.html](https://www.cnblogs.com/lhb25/p/how-browsers-work.html)

- [https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)

- [https://segmentfault.com/p/1210000012780980](https://segmentfault.com/p/1210000012780980)

- [http://blog.csdn.net/u013510838/article/details/55211033](http://blog.csdn.net/u013510838/article/details/55211033)

- [http://blog.csdn.net/Steward2011/article/details/51319298](http://blog.csdn.net/Steward2011/article/details/51319298)

- [http://www.imweb.io/topic/58e3bfa845e5c13468f567d5](http://www.imweb.io/topic/58e3bfa845e5c13468f567d5)

- [https://segmentfault.com/a/1190000008015671](https://segmentfault.com/a/1190000008015671)

- [https://juejin.im/post/5a4ed917f265da3e317df515](https://juejin.im/post/5a4ed917f265da3e317df515)

- [http://www.cnblogs.com/iovec/p/7904416.html](http://www.cnblogs.com/iovec/p/7904416.html)

- [https://www.cnblogs.com/wyaocn/p/5761163.html](https://www.cnblogs.com/wyaocn/p/5761163.html)

- [http://www.ruanyifeng.com/blog/2014/10/event-loop.html#comment-text](http://www.ruanyifeng.com/blog/2014/10/event-loop.html#comment-text)


